---
- name: Create VM
  connection: local
  gather_facts: false
  hosts: localhost
  tasks:
    - name: Create a VirtualMachine
      kubernetes.kubevirt.kubevirt_vm:
        state: present
        name: testvm3
        namespace: default
        labels:
          app: test
        wait: yes
        wait_timeout: 600
        spec:
          domain:
            cpu:
              sockets: 1
            memory:
              guest: 512Mi
            devices:
              interfaces:
                - name: default
                  masquerade: {}
                - name: bridge-network
                  bridge: {}
          networks:
            - name: default
              pod: {}
            - name: bridge-network
              multus:
                networkName: kindexgw
          volumes:
            - containerDisk:
                image: quay.io/containerdisks/fedora:latest
              name: containerdisk
            - cloudInitNoCloud:
                userData: |-
                  #cloud-config
                  # The default username is: fedora
                  ssh_authorized_keys:
                    - {{ lookup('file', 'pub_key') }}
              name: cloudinit

- name: Wait for ssh
  connection: local
  gather_facts: false
  hosts: localhost
  tasks:
    - name: Wait 300 seconds for port 22 to become open and contain "OpenSSH"
      ansible.builtin.wait_for:
        port: 22
        host: '{{ (ansible_ssh_host|default(ansible_host))|default(inventory_hostname) }}'
        search_regex: OpenSSH
        delay: 10
      connection: local
